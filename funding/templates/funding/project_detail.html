{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{{ project.title }}</title>
</head>
<body>
<h1>{{ project.title }}</h1>

{% if project.image %}
    <img src="{{ project.image.url }}" alt="{{ project.title }}" width="400">
{% endif %}

<p>{{ project.description }}</p>
<p>ç›®æ¨™é‡‘é¡: Â¥{{ project.goal_amount }}</p>
<p>ç¾åœ¨ã®æ”¯æ´é¡: Â¥{{ project.current_amount }}</p>
<p>æ”¯æ´è€…æ•°: {{ project.supporter_count }}</p>
<p>ã„ã„ã­æ•°: <span id="like-count">{{ project.like_count }}</span></p>
<p>æ®‹ã‚Šæ—¥æ•°: {{ project.days_left }}æ—¥</p>
<p>ä½œæˆè€…:
    {% if project.created_by.profile %}
        {% if project.created_by.profile.icon %}
            <img src="{{ project.created_by.profile.icon.url }}" alt="ã‚¢ã‚¤ã‚³ãƒ³" width="30" style="border-radius:50%;">
        {% endif %}
        {{ project.created_by.profile.name|default:project.created_by.email }}
    {% else %}
        {{ project.created_by.email }}
    {% endif %}
</p>


<p>ã‚¿ã‚°:
{% for tag in project.tags.all %}
    <span>{{ tag.name }}</span>
{% empty %}
    <span>ã‚¿ã‚°ãªã—</span>
{% endfor %}
</p>

<!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
{% if user.is_authenticated %}
<button id="like-btn" data-liked="{{ user_liked|yesno:'true,false' }}">
    {% if user_liked %}ğŸ’” ã„ã„ã­è§£é™¤{% else %}â¤ï¸ ã„ã„ã­{% endif %}
</button>
{% else %}
<p><a href="/accounts/login/">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã„ã­</a></p>
{% endif %}

<!-- ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆæ”¯æ´ï¼‰ä¸€è¦§ -->
<h2>ãƒªã‚¿ãƒ¼ãƒ³</h2>
<ul>
{% for reward in project.rewards.all %}
    <li>
        <strong>{{ reward.title }}</strong> - Â¥{{ reward.amount }}
        {% if reward.limit %} (æ®‹ã‚Š: {{ reward.limit }}å€‹) {% endif %}
        <form action="{% url 'checkout' project.pk %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="amount" value="{{ reward.amount }}">
            <button type="submit">ã“ã®ãƒªã‚¿ãƒ¼ãƒ³ã§æ”¯æ´ã™ã‚‹</button>
        </form>
    </li>
{% empty %}
    <li>ã¾ã ãƒªã‚¿ãƒ¼ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</li>
{% endfor %}
</ul>

{% if user.is_authenticated and user == project.created_by %}
<form action="{% url 'project_delete' project.pk %}" method="POST" style="margin-top:10px;">
    {% csrf_token %}
    <button type="submit" onclick="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
        ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤
    </button>
</form>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("like-btn");
  if (!btn) return;

  btn.addEventListener("click", () => {
    fetch(window.location.pathname + "like/", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest",
      },
    })
    .then(res => res.json())
    .then(data => {
      const countElem = document.getElementById("like-count");
      countElem.textContent = data.like_count;
      if (data.status === "liked") {
        btn.textContent = "ğŸ’” ã„ã„ã­è§£é™¤";
      } else {
        btn.textContent = "â¤ï¸ ã„ã„ã­";
      }
    });
  });
});
</script>

</body>
</html>
